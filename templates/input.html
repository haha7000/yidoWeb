<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영수증 및 여권 OCR - 파일 업로드</title>
    <style>
    body {
    font-family: 'Roboto', sans-serif;
    background-color: #f8f9fa;
}

/* 공통: 박스 스타일 */
.container {
    margin-top: 20px;
}

/* ------------------------------- */
/* input.html 전용 스타일 */
.upload-card {
    max-width: 500px;
    margin: 50px auto;
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}
.upload-card:hover {
    transform: translateY(-5px);
}
.drop-zone {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    background-color: #e9ecef;
    cursor: pointer;
    transition: background-color 0.3s;
}
.drop-zone.dragover {
    background-color: #d0e7ff;
}
.btn-upload {
    background-color: #007bff;
    border: none;
    padding: 10px 20px;
    font-weight: 500;
    transition: background-color 0.3s;
}
.btn-upload:hover {
    background-color: #0056b3;
}
.spinner {
    display: none;
}
.footer {
    background-color: #343a40;
    color: white;
    padding: 20px 0;
    text-align: center;
    width: 100%;
}


    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="/static/YidoLogo.png" alt="로고" style="height: 80px;">
        </a>
    </div>
</nav>

<div class="container">
    <div class="card upload-card">
        <div class="card-body">
            <h3 class="card-title text-center mb-4">ZIP 파일 업로드</h3>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="drop-zone mb-3" id="dropZone">
                    <p class="mb-0" id="fileNameDisplay">여기에 ZIP 파일을 드래그하거나 클릭하여 선택하세요</p>
                    <input type="file" id="folderInput" name="folder" accept=".zip" required>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-upload" id="submitBtn">
                        업로드
                        <span class="spinner spinner-border spinner-border-sm" id="spinner"></span>
                    </button>
                </div>
                <div id="progressBar" class="mt-3 text-center" style="font-weight: bold; display: none;">
                    처리 중: <span id="progressCount"></span>
                </div>
            </form>
            <div id="resultBox" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
// === edit_unmatched.html 관련 ===
let scale = 1;
let image = document.getElementById('receipt-image');

function zoomIn() {
    scale += 0.1;
    if (image) image.style.transform = `scale(${scale})`;
}

function zoomOut() {
    scale = Math.max(0.1, scale - 0.1);
    if (image) image.style.transform = `scale(${scale})`;
}

function resetZoom() {
    scale = 1;
    if (image) image.style.transform = `scale(${scale})`;
}

document.querySelector('.image-container')?.addEventListener('wheel', function(event) {
    event.preventDefault();
    event.deltaY < 0 ? zoomIn() : zoomOut();
});

function selectReceipt(receiptNumber, filePath, receiptId) {
    const newReceiptInput = document.querySelector('input[name="new_receipt_number"]');
    const leftPanel = document.querySelector('.left-panel');
    const form = document.getElementById('update-form');

    newReceiptInput.value = receiptNumber;
    form.action = `/edit_unmatched/${receiptId}`;

    leftPanel.innerHTML = `
        <h3>선택된 영수증</h3>
        <div class="image-container">
            <img class="receipt-image" id="receipt-image" src="${filePath}" alt="Selected Receipt">
        </div>
        <div class="zoom-controls">
            <button type="button" class="btn btn-secondary" onclick="zoomIn()">확대 (+)</button>
            <button type="button" class="btn btn-secondary" onclick="zoomOut()">축소 (-)</button>
            <button type="button" class="btn btn-secondary" onclick="resetZoom()">초기화</button>
        </div>
    `;
    scale = 1;
    image = document.getElementById('receipt-image');
    clearError();
}

function searchReceipt() {
    const receiptNumber = document.querySelector('input[name="new_receipt_number"]').value;
    const batchId = document.querySelector('input[name="upload_batch_id"]').value;
    window.location.href = `/edit_unmatched/${encodeURIComponent(receiptNumber)}?upload_batch_id=${batchId}`;
    clearError();
}

function showError(message) {
    const errorMessage = document.getElementById('error-message');
    const receiptInput = document.querySelector('input[name="new_receipt_number"]');
    errorMessage.style.display = 'block';
    errorMessage.textContent = message;
    receiptInput.classList.add('input-error');
}

function clearError() {
    const errorMessage = document.getElementById('error-message');
    const receiptInput = document.querySelector('input[name="new_receipt_number"]');
    errorMessage.style.display = 'none';
    errorMessage.textContent = '';
    receiptInput.classList.remove('input-error');
}

document.getElementById('update-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const receiptInput = document.querySelector('input[name="new_receipt_number"]');
    const newValue = receiptInput.value.trim();
    if (!newValue) {
        showError('영수증 번호를 입력해주세요.');
        return;
    }

    const formData = new FormData(e.target);
    try {
        const response = await fetch(e.target.action, {
            method: 'POST',
            body: formData
        });
        if (response.ok) {
            const batchId = document.querySelector('input[name="upload_batch_id"]').value;
            window.location.href = `/result/?upload_batch_id=${batchId}`;
        } else {
            const result = await response.json();
            showError(result.error || result.detail || '오류가 발생했습니다.');
        }
    } catch (error) {
        console.error('Error updating receipt:', error);
        showError('서버 오류가 발생했습니다.');
    }
});

// === input.html 관련 ===
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('folderInput');
const submitBtn = document.getElementById('submitBtn');
const spinner = document.getElementById('spinner');
const resultBox = document.getElementById('resultBox');
const uploadForm = document.getElementById('uploadForm');
const progressStatus = document.getElementById('progressBar');
const progressCount = document.getElementById('progressCount');

dropZone?.addEventListener('click', () => fileInput?.click());
dropZone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
});
dropZone?.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
});
dropZone?.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length && files[0].name.endsWith('.zip')) {
        fileInput.files = files;
        document.getElementById('fileNameDisplay').textContent = `선택된 파일: ${files[0].name}`;
    } else {
        resultBox.innerHTML = '<div class="alert alert-danger">ZIP 파일만 업로드 가능합니다.</div>';
    }
});

fileInput?.addEventListener('change', () => {
    if (fileInput.files.length && fileInput.files[0].name.endsWith('.zip')) {
        document.getElementById('fileNameDisplay').textContent = `선택된 파일: ${fileInput.files[0].name}`;
    } else {
        resultBox.innerHTML = '<div class="alert alert-danger">ZIP 파일만 선택해주세요.</div>';
        fileInput.value = '';
    }
});

let progressInterval = null;
function startProgressPolling() {
    if (!progressStatus || !progressCount) return;
    
    // 진행상황 표시 영역을 먼저 보이게 설정
    progressStatus.style.display = 'block';
    progressCount.textContent = '0/0';  // 초기값 설정
    
    progressInterval = setInterval(async () => {
        try {
            const res = await fetch('/progress/');
            const data = await res.json();
            console.log('Progress data:', data);  // 디버깅용 로그
            
            if (data && typeof data.done === 'number' && typeof data.total === 'number') {
                progressCount.textContent = `${data.done}/${data.total}`;
                
                // 모든 처리가 완료되면 진행상황 표시 영역 숨김
                if (data.done >= data.total) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        progressStatus.style.display = 'none';
                    }, 1000);  // 1초 후 숨김
                }
            }
        } catch (e) {
            console.error('진행 상태 에러:', e);
            clearInterval(progressInterval);
            progressStatus.style.display = 'none';
        }
    }, 1000);
}

uploadForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!fileInput.files.length) {
        resultBox.innerHTML = '<div class="alert alert-danger">파일을 선택해주세요.</div>';
        return;
    }

    submitBtn.disabled = true;
    spinner.style.display = 'inline-block';
    resultBox.innerHTML = '<div class="alert alert-info">파일을 처리 중입니다...</div>';
    
    // 진행상황 표시 시작
    startProgressPolling();

    const formData = new FormData();
    formData.append('folder', fileInput.files[0]);
    try {
        const response = await fetch('/result/', {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'text/html' }
        });
        if (response.ok) {
            clearInterval(progressInterval);
            const html = await response.text();
            document.open();
            document.write(html);
            document.close();
        } else {
            const errorText = await response.text();
            resultBox.innerHTML = `<div class="alert alert-danger">오류: ${errorText}</div>`;
            progressStatus.style.display = 'none';  // 오류 시 진행상황 숨김
        }
    } catch (error) {
        console.error('Upload error:', error);
        resultBox.innerHTML = `<div class="alert alert-danger">요청 실패: ${error.message}</div>`;
        progressStatus.style.display = 'none';  // 오류 시 진행상황 숨김
    } finally {
        submitBtn.disabled = false;
        spinner.style.display = 'none';
    }
});

// === result.html 검색 필터 ===
document.getElementById('searchInput')?.addEventListener('input', function() {
    const searchValue = this.value.toLowerCase();
    const accordionItems = document.querySelectorAll('.accordion-item');
    accordionItems.forEach(item => {
        const customerText = item.querySelector('.accordion-button').textContent.toLowerCase();
        const rows = item.querySelectorAll('.table tbody tr');
        let hasMatch = customerText.includes(searchValue);
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchValue)) hasMatch = true;
        });
        item.style.display = hasMatch ? '' : 'none';
    });

    const unmatchedItems = document.querySelectorAll('.unmatched-list .list-group-item');
    unmatchedItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchValue) ? '' : 'none';
    });
});
</script>
</body>
</html>
