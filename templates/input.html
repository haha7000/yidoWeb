{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="card upload-card">
        <div class="card-body">
            <div class="text-center mb-4">
                <img src="/static/YidoLogo.png" alt="로고" style="height: 80px;">
                <h3 class="mt-3">ZIP 파일 업로드</h3>
                <p class="text-muted">영수증과 여권 이미지가 포함된 ZIP 파일을 업로드하세요</p>
                <div class="badge bg-info mb-2">{{ duty_free_type }}</div>
            </div>
            
            <!-- 이전 결과 확인 버튼 -->
            <div class="text-center mb-4">
                <a href="/result/" class="btn btn-outline-info me-2" id="viewResultBtn">
                    <i class="fas fa-history me-2"></i>이전 처리 결과 보기
                </a>
                <a href="/excel-upload/" class="btn btn-outline-success me-2">
                    <i class="fas fa-file-excel me-2"></i>엑셀 데이터 업로드
                </a>
                <button type="button" class="btn btn-outline-secondary" onclick="checkProcessingStatus()">
                    <i class="fas fa-info-circle me-2"></i>처리 현황 확인
                </button>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="drop-zone mb-3" id="dropZone">
                    <p class="mb-0" id="fileNameDisplay">여기에 ZIP 파일을 드래그하거나 클릭하여 선택하세요</p>
                    <input type="file" id="folderInput" name="folder" accept=".zip" required style="display: none;">
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-upload" id="submitBtn">
                        <i class="fas fa-upload me-2"></i>업로드 및 처리 시작
                        <span class="spinner spinner-border spinner-border-sm" id="spinner"></span>
                    </button>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        처리 시간은 이미지 개수에 따라 달라질 수 있습니다
                    </small>
                </div>
                <div id="progressBar" class="mt-3 text-center" style="font-weight: bold; display: none;">
                    처리 중: <span id="progressCount">0/0</span>
                </div>
            </form>
            <div id="resultBox" class="mt-3"></div>
            
            <!-- 빈 상태일 때 도움말 -->
            <div class="help-section mt-4" id="helpSection">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-question-circle text-info me-2"></i>사용 방법
                        </h6>
                        <ul class="list-unstyled mb-0 small">
                            <li><i class="fas fa-check text-success me-2"></i>영수증과 여권 이미지를 하나의 ZIP 파일로 압축</li>
                            <li><i class="fas fa-check text-success me-2"></i>지원 형식: JPG, PNG, JPEG</li>
                            <li><i class="fas fa-check text-success me-2"></i>한글 및 영문 텍스트 자동 인식</li>
                            <li><i class="fas fa-check text-success me-2"></i>처리 완료 후 수령증 자동 생성</li>
                            <li class="mt-2"><i class="fas fa-info-circle text-warning me-2"></i><strong>엑셀 데이터를 먼저 업로드해주세요!</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 업로드 페이지 전용 스타일 */
.upload-card {
    max-width: 600px;
    margin: 50px auto;
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}

.upload-card:hover {
    transform: translateY(-5px);
}

.drop-zone {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px 20px;
    text-align: center;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.drop-zone:hover {
    background-color: #e3f2fd;
    border-color: #0056b3;
}

.drop-zone.dragover {
    background-color: #d0e7ff;
    border-color: #0056b3;
    transform: scale(1.02);
}

.btn-upload {
    background-color: #007bff;
    border: none;
    padding: 12px 30px;
    font-weight: 500;
    border-radius: 25px;
    transition: all 0.3s;
    color: white;
}

.btn-upload:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    color: white;
}

.btn-upload:disabled {
    background-color: #6c757d;
    transform: none;
    box-shadow: none;
}

.spinner {
    display: none;
}

#progressBar {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 14px;
}

.progress-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* 알림 스타일 개선 */
.alert {
    border-radius: 8px;
    border: none;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
}

.alert-info {
    background-color: #d1ecf1;
    color: #0c5460;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('folderInput');
    const submitBtn = document.getElementById('submitBtn');
    const spinner = document.getElementById('spinner');
    const resultBox = document.getElementById('resultBox');
    const uploadForm = document.getElementById('uploadForm');
    const progressStatus = document.getElementById('progressBar');
    const progressCount = document.getElementById('progressCount');
    const fileNameDisplay = document.getElementById('fileNameDisplay');

    // 드롭존 클릭 시 파일 선택
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });

    // 드래그 오버
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    // 드래그 떠남
    dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('dragover');
    });

    // 파일 드롭
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.name.toLowerCase().endsWith('.zip')) {
                fileInput.files = files;
                fileNameDisplay.innerHTML = `<i class="fas fa-file-archive text-primary"></i> 선택된 파일: <strong>${file.name}</strong>`;
                resultBox.innerHTML = '';
            } else {
                resultBox.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ZIP 파일만 업로드 가능합니다.</div>';
            }
        }
    });

    // 파일 선택 변경
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.name.toLowerCase().endsWith('.zip')) {
                fileNameDisplay.innerHTML = `<i class="fas fa-file-archive text-primary"></i> 선택된 파일: <strong>${file.name}</strong>`;
                resultBox.innerHTML = '';
                toggleHelpSection();
            } else {
                resultBox.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ZIP 파일만 선택해주세요.</div>';
                fileInput.value = '';
                fileNameDisplay.textContent = '여기에 ZIP 파일을 드래그하거나 클릭하여 선택하세요';
                toggleHelpSection();
            }
        } else {
            toggleHelpSection();
        }
    });

    // 진행상황 폴링
    let progressInterval = null;
    
    function startProgressPolling() {
        if (!progressStatus || !progressCount) return;
        
        progressStatus.style.display = 'block';
        progressStatus.classList.add('progress-animation');
        progressCount.textContent = '0/0';
        
        progressInterval = setInterval(async function() {
            try {
                const response = await fetch('/progress/');
                const data = await response.json();
                
                if (data && typeof data.done === 'number' && typeof data.total === 'number') {
                    progressCount.textContent = `${data.done}/${data.total}`;
                    
                    if (data.done >= data.total && data.total > 0) {
                        clearInterval(progressInterval);
                        progressStatus.classList.remove('progress-animation');
                        setTimeout(function() {
                            progressStatus.style.display = 'none';
                        }, 1500);
                    }
                }
            } catch (error) {
                console.error('진행 상태 조회 오류:', error);
                clearInterval(progressInterval);
                progressStatus.style.display = 'none';
                progressStatus.classList.remove('progress-animation');
            }
        }, 1000);
    }

    // 처리 현황 확인 함수
    async function checkProcessingStatus() {
        try {
            const response = await fetch('/progress/');
            const data = await response.json();
            
            if (data.total > 0) {
                const percentage = Math.round((data.done / data.total) * 100);
                showNotification(
                    `현재 처리 중: ${data.done}/${data.total} (${percentage}%)`, 
                    'info'
                );
            } else {
                showNotification('현재 처리 중인 작업이 없습니다.', 'info');
            }
        } catch (error) {
            showNotification('처리 현황을 확인할 수 없습니다.', 'warning');
        }
    }

    // 알림 함수
    function showNotification(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                           type === 'error' ? 'fa-exclamation-triangle' : 
                           type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 5초 후 자동 제거
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // 도움말 섹션 토글
    function toggleHelpSection() {
        const helpSection = document.getElementById('helpSection');
        if (fileInput.files.length > 0 || resultBox.innerHTML.trim() !== '') {
            helpSection.style.display = 'none';
        } else {
            helpSection.style.display = 'block';
        }
    }

    // 폼 제출
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            resultBox.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> 파일을 선택해주세요.</div>';
            return;
        }

        // UI 상태 변경
        submitBtn.disabled = true;
        spinner.style.display = 'inline-block';
        resultBox.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> 파일을 업로드하고 처리 중입니다...</div>';
        toggleHelpSection();
        
        // 진행상황 폴링 시작
        startProgressPolling();

        const formData = new FormData();
        formData.append('folder', fileInput.files[0]);
        
        try {
            const response = await fetch('/result/', {
                method: 'POST',
                body: formData,
                headers: { 
                    'Accept': 'text/html' 
                }
            });
            
            if (response.ok) {
                // 진행상황 폴링 중단
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                // 성공 시 결과 페이지로 리다이렉트
                const html = await response.text();
                document.open();
                document.write(html);
                document.close();
            } else {
                // 오류 처리
                const errorText = await response.text();
                resultBox.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> 오류: ${errorText}</div>`;
                progressStatus.style.display = 'none';
                progressStatus.classList.remove('progress-animation');
            }
        } catch (error) {
            console.error('업로드 오류:', error);
            resultBox.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> 네트워크 오류: ${error.message}</div>`;
            progressStatus.style.display = 'none';
            progressStatus.classList.remove('progress-animation');
        } finally {
            // UI 상태 복원
            submitBtn.disabled = false;
            spinner.style.display = 'none';
            
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        }
    });

    // 페이지 로드 시 도움말 표시
    toggleHelpSection();

    // 이전 결과 보기 버튼 클릭 처리
    document.getElementById('viewResultBtn').addEventListener('click', async function(e) {
        const btn = this;
        const originalText = btn.innerHTML;
        
        try {
            // 로딩 상태
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>결과 확인 중...';
            btn.classList.add('disabled');
            
            // 잠시 대기 후 페이지 이동 (사용자가 로딩을 인지할 수 있도록)
            setTimeout(() => {
                window.location.href = '/result/';
            }, 500);
            
        } catch (error) {
            // 오류 시 원래 상태로 복구
            btn.innerHTML = originalText;
            btn.classList.remove('disabled');
            showNotification('결과 페이지로 이동할 수 없습니다.', 'error');
        }
    });

    // 전역 함수로 노출 (HTML onclick에서 사용)
    window.checkProcessingStatus = checkProcessingStatus;
});
</script>
{% endblock %}